## 2.9 Railsアプリケーションのデプロイ

ここではHerokuのようなPaaS（Platform as a Service）と呼ばれるクラウドサービス以外へのデプロイについて解説します。デプロイは、サーバー用のPCを用意し、OSや使用する言語をインストールし、セキュリティーなどの設定を追加し、そのうえでプログラムファイルを設置して動作確認をするという、とても手間がかかるものです。

手間がかかると言っても仕事の内容によってはVPSを利用する場合もあります。ここではCapistranoを利用したVPSへのRailsアプリケーションのデプロイを解説します。CapistranoはRubyで作られたデプロイを自動化するツールです。Capistranoが行う作業を手作業で行うとしたら、SSHでログインして、DBのバックアップを取り、Githubからソースコードをcloneして、マイグレーションを実行し、pumaのプロセスを再起動する作業を手作業で行う必要があります。これがアプリケーションを冗長化構成していた場合はさらに作業が煩雑になり熟練度が必要になります。Rubyプログラムへの熟練度は必要ですが、特定の環境でしか活かせない作業への熟練度は不要で均一化かつ、自動化すべきです。

VPSへのデプロイに必要な工程は以下のとおりです。Railsアプリケーションの作業とVPSで行う作業を交互に行う必要がありますので、確実に進めていきましょう

1. VPS構築
    1. apt-get update & upgrade
    1. デプロイユーザー作成
    1. SSHの設定変更
1. Railsアプリケーション
    1. gemインストール
        - capistrano
        - puma
        - pg
    1. デプロイタスク作成
    1. database.ymlの変更
1. Github
    1. Deploy keyの登録
1. 環境構築
    1. RVM
    1. Nginx
    1. PostgreSQL
    1. 環境変数への反映

### 2.9.1 VPS構築

#### apt-get update & upgrade
OSをインストールした直後は、必要なパッケージが揃っていない場合があります。`apt-get update`と`apt-get upgrade`を実行しましょう。

```
$ apt-get update
$ apt-get upgrade
```

#### デプロイユーザー作成
Capistranoはサーバー上にあるユーザーを使ってデプロイに必要な作業を行います。１つのVPSに複数のアプリがある場合でもユーザーを１つにしたほうが管理が楽になります。デプロイに利用するユーザーをdeployとします。日本語の読みでは同じ「デプロイ」になりますが、デプロイはVPSにRailsアプリケーションを展開する作業を指し、deployはサーバー上のアカウントを指します。

```
$ adduser deploy
Adding user `deploy' ...
Adding new group `deploy' (1000) ...
Adding new user `deploy' (1000) with group `deploy' ...
Creating home directory `/home/deploy' ...
Copying files from `/etc/skel' ...
Enter new UNIX password:
Retype new UNIX password:
passwd: password updated successfully
Changing the user information for deploy
Enter the new value, or press ENTER for the default
	Full Name []:
	Room Number []:
	Work Phone []:
	Home Phone []:
	Other []:
Is the information correct? [Y/n] Y
```

今後は、deployユーザーで作業しますのでsudoコマンドが使えるように設定を変更します。`visudo`コマンドを実行して、以下の内容を追加してください。

```
deploy  ALL=NOPASSWD: ALL
```

#### SSHの設定変更
VPSを運営している会社にもよりますが、rootでのSSH接続を許可している場合があります。また、ポート番号も22番だと攻撃の対象となりやすいため変更します。筆者の経験上、VPSでSSH接続に秘密鍵を必須にした場合、デプロイできる開発メンバーが増えた場合に鍵の運用が煩雑になりやすい為、ここでは秘密鍵は作成しません。会社のセキュリティポリシーによりますので適宜、作業内容は追加してください。

ポート番号を2525、rootでのSSH接続をオフに変更します。`diff`コマンドの実行結果の通りにdeployユーザーでログインして、`/etc/ssh/sshd_config`を編集してください。

```diff
--- /etc/ssh/sshd_config	2017-10-22 11:56:32.963014197 +0900
+++ /etc/ssh/sshd_config.cpy	2017-10-21 19:31:07.493249195 +0900
@@ -2,7 +2,7 @@
 # See the sshd_config(5) manpage for details

 # What ports, IPs and protocols we listen for
-Port 2525
+Port 22
 # Use these options to restrict which interfaces/protocols sshd will bind to
 #ListenAddress ::
 #ListenAddress 0.0.0.0
@@ -25,7 +25,7 @@

 # Authentication:
 LoginGraceTime 120
-PermitRootLogin no
+PermitRootLogin yes
 StrictModes yes

 RSAAuthentication yes
```

編集が終わったら、デーモンを再起動しましょう。

```
$ sudo service ssh restart
```

設定が反映されているか確認するため、ログアウトします。ポート番号が2525でVPSにSSH接続してみましょう。無事にVPSにログインできたら成功です。

### 2.9.2 Capistranoタスクの作成

#### gemインストール

デプロイに必要なgemを追加しましょう。Gemfileに以下の内容を追加してください。

```
group :development do
  gem "capistrano", "~> 3.9", require: false
  gem 'capistrano-rvm', require: false
  gem 'capistrano-rails', require: false
  gem 'capistrano-bundler', require: false
  gem 'capistrano3-puma', require: false
end

gem 'puma', "~> 3.7"

group :production do
  gem 'pg'
end
```

#### デプロイタスク作成

Capistranoに必要な設定ファイルを作成しましょう。`cap install`を実行するとRailsアプリケーションに必要なファイルを作成してくれます。この教材では`Capfile`と`config/deploy.rb`を利用します。

```
$ bundle exec cap install
mkdir -p config/deploy
create config/deploy.rb
create config/deploy/staging.rb
create config/deploy/production.rb
mkdir -p lib/capistrano/tasks
create Capfile
Capified
```

- Capfile

```diff
--- a/Capfile
+++ b/Capfile
@@ -34,5 +34,16 @@ install_plugin Capistrano::SCM::Git
 # require "capistrano/rails/migrations"
 # require "capistrano/passenger"

+require 'capistrano/rails'
+require 'capistrano/bundler'
+require 'capistrano/rvm'
+require 'capistrano/puma'
+
+install_plugin Capistrano::Puma  # Default puma tasks
+install_plugin Capistrano::Puma::Workers  # if you want to control the workers (in cluster mode)
+install_plugin Capistrano::Puma::Jungle # if you need the jungle tasks
+install_plugin Capistrano::Puma::Monit  # if you need the monit tasks
+install_plugin Capistrano::Puma::Nginx  # if you want to upload a nginx site template
+
 # Load custom tasks from `lib/capistrano/tasks` if you have any defined
 Dir.glob("lib/capistrano/tasks/*.rake").each { |r| import r }
```

- config/deploy.rb

```
lock "3.9.1"

set :application, "monka-app"
set :repo_url, "#{ # ここにリポジトリのURLを設定してください }"

server "#{ # サーバーのIPアドレスを設定してください }", port: 2525, roles: [:app, :web, :db], primary: true

# user
set :user,            'deploy'
set :use_sudo,        false

# server
set :stage,           :production
set :deploy_via,      :remote_cache
set :deploy_to,       "/var/www/rails/#{fetch(:application)}"

# puma
set :puma_threads,    [4, 16]
set :puma_workers,    0
set :puma_bind,       "unix://#{shared_path}/tmp/sockets/#{fetch(:application)}.sock"
set :puma_state,      "#{shared_path}/tmp/pids/puma.state"
set :puma_pid,        "#{shared_path}/tmp/pids/puma.pid"
set :puma_access_log, "#{release_path}/log/puma.access.log"
set :puma_error_log,  "#{release_path}/log/puma.error.log"
set :puma_preload_app, true
set :puma_worker_timeout, nil
set :puma_init_active_record, true

# terminal
set :pty,             true

# ssh
set :ssh_options,     {
  user: 'deploy'
}

# rvm
set :rvm_ruby_version, 'ruby-2.4.1'

# environment
set :linked_dirs, fetch(:linked_dirs, []).push(
  'log',
  'tmp/pids',
  'tmp/cache',
  'tmp/sockets',
  'vendor/bundle',
  'public/system',
  'public/uploads'
)
set :linked_files, fetch(:linked_files, []).push(
  'config/database.yml',
  'config/secrets.yml'
)

namespace :puma do
  desc 'Create Directories for Puma Pids and Socket'
  task :make_dirs do
    on roles(:app) do
      execute "mkdir #{shared_path}/tmp/sockets -p"
      execute "mkdir #{shared_path}/tmp/pids -p"
    end
  end

  before :start, :make_dirs
end

namespace :deploy do
  desc "Make sure local git is in sync with remote."
  task :check_revision do
    on roles(:app) do
      unless `git rev-parse HEAD` == `git rev-parse origin/master`
        puts "WARNING: HEAD is not the same as origin/master"
        puts "Run `git push` to sync changes."
        exit
      end
    end
  end

  desc 'Restart application'
  task :restart do
    on roles(:app), in: :sequence, wait: 5 do
      invoke 'puma:restart'
    end
  end

  desc 'Upload database.yml and secrets.yml'
  task :upload do
    on roles(:app) do |host|
      if test "[ ! -d #{shared_path}/config ]"
        execute "mkdir -p #{shared_path}/config"
      end
      upload!('config/database.yml', "#{shared_path}/config/database.yml")
      upload!('config/secrets.yml', "#{shared_path}/config/secrets.yml")
    end
  end

  before :starting,     :upload
  before :starting,     :check_revision
end
```

#### database.ymlの変更

データベースはPostgreSQLを利用します。database.ymlを以下のように編集してください。データベースの接続に必要なユーザー、パスワードは後の手順で環境変数として設定します。

```diff
--- a/config/database.yml
+++ b/config/database.yml
@@ -21,5 +21,10 @@ test:
   database: db/test.sqlite3

 production:
-  <<: *default
-  database: db/production.sqlite3
+  adapter: postgresql
+  encoding: utf8
+  pool: 5
+  username: <%= ENV['PG_USER'] %>
+  password: <%= ENV['PG_PW'] %>
+  host: localhost
+  database: monka_production
```

### 2.9.3 Github

#### Deploy keyの登録

deployユーザーはRailsアプリケーションをcloneする必要があります。公開リポジトリであれば問題ないのですが、プライベートリポジトリはコラボレーターであったり、リポジトリの所有者である必要があります。

GithubにDeploy keyを登録することによりGithubにアカウントを登録すること無くcloneが出来るようになります。

詳しい手順、解説はGithubに解説ページがあるので参考にしてください。

URL：https://developer.github.com/v3/guides/managing-deploy-keys/#deploy-keys

### 2.9.4 環境構築

####  RVMインストール
VPSにRubyをインストールします。通常は`apt-get`や`yum`でパッケージをRubyのパッケージをインストールします。ですが、リリース時期によってはRailsのバージョンが異なるため、Rubyのバージョンも異なる場合が多くあります。複数のバージョンを管理するために`rvm`や`rbenv`があります。ここでは`rvm`を使ってRubyをインストールします。

RVMについて詳しく知りたい方は公式ページで確認してください。

URL：https://rvm.io/

- GPG鍵インストール

```
$ gpg --keyserver hkp://keys.gnupg.net --recv-keys 409B6B1796C275462A1703113804BB82D39DC0E3 7D2BAF1CF37B13E2069D6956105BD0E739499BDB
```

- RVMインストール

```
$ curl -sSL https://get.rvm.io | bash -s stable
$ source /home/deploy/.rvm/scripts/rvm
```

- Ruby2.4.1インストール

```
$ rvm install ruby-2.4
```

- Bundlerインストール
VPSでRailsアプリケーションを正しく動作するために`bundle install`を実行する必要があります。VPSで`Bundler`をインストールしておきます。Capistranoでインストールまで出来たら良いのですがサーバーの設定までは出来ません。

```
$ gem install bundler
```

####  Nginxインストール

リバースプロキシサーバとしてNginxを利用します。手順に沿って、パッケージインストールと設定ファイルの編集を行ってください。

```
$ sudo apt-get install nginx -y
$ sudo rm -rf /etc/nginx/sites-enabled/default
$ sudo cp -p /etc/nginx/sites-enabled/default /etc/nginx/sites-enabled/monka
```

`sites-available`にあるファイルはRailsアプリケーション毎に作成します。ここでは`monka`ファイルを作成してRailsアプリケーションが動くように変更します。

- `/etc/nginx/sites-enabled/monka`

```
upstream puma {
  server unix:///var/www/rails/monka-app/shared/tmp/sockets/monka-app.sock;
}

server {
  listen 80 default_server deferred;

  root /var/www/rails/monka-app/current/public;

  access_log /var/www/rails/monka-app/current/log/nginx.access.log;
  error_log /var/www/rails/monka-app/current/log/nginx.error.log info;

  location ^~ /assets/ {
    gzip_static on;
    expires max;
    add_header Cache-Control public;
  }

  try_files $uri/index.html $uri @puma;
  location @puma {
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header Host $http_host;
    proxy_redirect off;

    proxy_pass http://puma;
  }

  error_page 500 502 503 504 /500.html;
  client_max_body_size 10M;
  keepalive_timeout 10;
}
```

設定したら`sites-available`にあるファイルを`sites-enabled`にシンボリックリンクを貼ります。

```
$ sudo ln -s /etc/nginx/sites-available/monka /etc/nginx/sites-enabled/
```

ここまで設定が完了したら、設定ファイルを読み込ませるためにプロセスを再起動しましょう。

```
$ sudo service postgresql restart
```

####  PostgreSQLインストール

データベースはPostgreSQLを利用します。database.ymlにあるデータベース名をPostgreSQLで作ります。手順に沿って、パッケージインストールと設定ファイルの編集を行ってください。

```
$ sudo apt-get install postgresql postgresql-contrib libpq-dev -y
```

PostgreSQLの設定ファイルは`pg_hba.conf`です。アプリケーション毎にユーザーを作成します。今回はアプリケーションは１つなので`monka`ユーザーをPostgreSQLに追加します。同じVPSにアプリケーションを増やす場合でも同様の手順で対応できます。

```
--- /etc/postgresql/9.5/main/pg_hba.conf	2017-10-22 15:25:22.793549397 +0900
+++ /etc/postgresql/9.5/main/pg_hba.conf.cpy	2017-10-22 15:26:52.739016727 +0900
@@ -83,7 +83,6 @@
 #
 # Database administrative login by Unix domain socket
 local   all             postgres                                peer
-local   all             monka                                   md5

 # TYPE  DATABASE        USER            ADDRESS                 METHOD
```

PostgreSQLの操作は`postgres`ユーザーで行います。

```
$ sudo su - postgres
$ psql # postgresユーザーで実行してください
```

psqlのプロンプトが立ち上がったら以下の手順通り実行してください。

```
postgres=# create role monka with createdb login password 'monka-app';
CREATE ROLE
postgres=# \du
                                   List of roles
 Role name |                         Attributes                         | Member of
-----------+------------------------------------------------------------+-----------
 monka     | Create DB                                                  | {}
 postgres  | Superuser, Create role, Create DB, Replication, Bypass RLS | {}

postgres=# create database monka_production owner monka;
CREATE DATABASE
postgres=# \l
                                     List of databases
       Name       |  Owner   | Encoding |   Collate   |    Ctype    |   Access privileges   
------------------+----------+----------+-------------+-------------+-----------------------
 monka_production | monka    | UTF8     | en_US.UTF-8 | en_US.UTF-8 |
 postgres         | postgres | UTF8     | en_US.UTF-8 | en_US.UTF-8 |
 template0        | postgres | UTF8     | en_US.UTF-8 | en_US.UTF-8 | =c/postgres          +
                  |          |          |             |             | postgres=CTc/postgres
 template1        | postgres | UTF8     | en_US.UTF-8 | en_US.UTF-8 | =c/postgres          +
                  |          |          |             |             | postgres=CTc/postgres
(4 rows)
```

ここまで設定が完了したら、設定ファイルを読み込ませるためにプロセスを再起動しましょう。

```
$ sudo service postgresql restart
```

####  環境変数への反映
database.ymlにあるPostgreSQLのユーザー、パスワードはたとえプライベートリポジトリであってもバージョン管理の対象にしてはいけません。こういった情報は環境変数にしてサーバー固有の値にすることが多いです。問題が特になければ`/etc/environment`に環境変数を設定します。

- `/etc/environment`  
```
PG_USER="monka"
PG_PW="monka-app"
SECRET_KEY_BASE="XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX"
```

### 2.9.5 ふりかえり
ここまでの長い道のりお疲れ様でした。さっそくVPSにRailsアプリケーションをデプロイしてみましょう。

```
$ cap production deploy:upload
$ cap production deploy:check
$ cap production deploy
```

ブラウザで確認してみてください。アプリケーションが無事にデプロイされたでしょうか？

VPSでのリバースプロキシサーバやデータベースの設定はやる機会は少ないため、Railsアプリケーションの開発からデプロイ環境の構築まで幅広くサポート出来るエンジニアは少ないと思います。このカリキュラムが参考になれば幸いです。
